<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - velva.clip</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bs-body-font-family: 'Inter', sans-serif;
            --bs-body-bg: #f8f9fa;
            --bs-body-color: #212529;
            --bs-primary: #8b5cf6;
            --bs-primary-rgb: 139, 92, 246;
            --bs-secondary: #6c757d;
            --bs-success: #44bd32;
            --bs-danger: #dc3545;
            --bs-border-color: #dee2e6;
            --bs-card-bg: #ffffff;
            --bs-shadow-md: 0 .5rem 1rem rgba(0,0,0,.15);
            --bs-shadow-lg: 0 1rem 3rem rgba(0,0,0,.175);
        }

        body {
            font-family: var(--bs-body-font-family);
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        .navbar {
            background-color: var(--bs-card-bg);
            border-bottom: 1px solid var(--bs-border-color);
        }

        .logo img {
            height: 40px;
        }

        .welcome-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--bs-border-color);
            margin-bottom: 2.5rem;
        }
        
        .process-card {
            background-color: var(--bs-card-bg);
            border-radius: 1rem;
            box-shadow: var(--bs-shadow-md);
            transition: all 0.3s ease;
        }
        
        .process-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--bs-shadow-lg);
        }

        .clips-grid {
            display: grid;
            gap: 2rem;
        }

        .clip-card {
            background-color: var(--bs-light);
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: var(--bs-shadow-sm);
            transition: all 0.3s ease;
        }

        .clip-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--bs-shadow-md);
        }
        
        .video-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 9/16;
            background-color: #000;
            cursor: pointer;
            border-radius: 0.75rem 0 0 0.75rem;
            overflow: hidden;
        }

        .clip-card video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .video-thumbnail-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }
        
        .video-wrapper.is-playing .video-thumbnail-overlay {
            opacity: 0;
        }

        .video-wrapper.is-playing video {
            opacity: 1;
        }

        .play-icon {
            font-size: 3rem;
            color: rgba(255, 255, 255, 0.9);
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            padding: 0.5rem;
        }

        .clip-timer-overlay {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 10;
        }

        .clip-info {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .clip-title {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .clip-description {
            font-size: 0.9rem;
            color: var(--bs-gray-600);
            margin-bottom: 1rem;
        }

        .btn-download {
            background-color: var(--bs-primary);
            color: #fff;
            font-weight: 600;
        }

        .live-progress-card {
            background-color: var(--bs-card-bg);
            border-radius: 1rem;
            box-shadow: var(--bs-shadow-md);
        }

        .live-video-preview {
            aspect-ratio: 16/9;
            background-color: #000;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
        }

        .live-progress-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            color: #fff;
            text-align: center;
        }

        #live-progress-bar-container {
            width: 80%;
            height: 30px;
            background: rgba(255,255,255,0.2);
        }

        #live-progress-bar-fill {
            height: 100%;
            background: var(--bs-success);
            transition: width 0.3s ease-in-out;
        }

        #progress-percentage-text {
            font-weight: 600;
            color: #fff;
            position: absolute;
        }

        .no-jobs {
            padding: 3rem;
            text-align: center;
            background-color: var(--bs-card-bg);
            border-radius: 1rem;
            box-shadow: var(--bs-shadow-md);
        }
        
        .flash-message {
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-left: 5px solid;
            border-radius: 0.5rem;
            font-weight: 500;
        }
        .flash-message.success {
            background-color: rgba(68, 189, 50, 0.1);
            border-color: var(--bs-success);
            color: var(--bs-success);
        }
        .flash-message.error {
            background-color: rgba(220, 53, 69, 0.1);
            border-color: var(--bs-danger);
            color: var(--bs-danger);
        }

        /* Custom badge styles for plans */
        .badge-soft-secondary {
            background-color: rgba(108, 117, 125, 0.1);
            color: var(--bs-secondary);
            font-size: 0.8em;
            font-weight: 500;
            padding: 0.25em 0.5em;
            border-radius: 9999px;
        }

        .badge-info-custom {
            background-color: rgba(23, 162, 184, 0.15);
            color: #1593a8;
            font-size: 0.8em;
            font-weight: 500;
            padding: 0.25em 0.5em;
            border-radius: 9999px;
        }
        
        .badge-outline-primary {
            background-color: transparent;
            border: 2px dotted var(--bs-primary);
            color: var(--bs-primary);
            font-weight: 600;
            padding: 0.35em 0.8em;
            border-radius: 9999px;
            font-size: 0.875rem;
        }

        .dashboard-title-h1 {
            color: var(--bs-body-color);
            font-weight: 800;
            font-size: 2.5rem;
        }
        
        /* Custom accent button style */
        .btn-accent-custom {
            background-color: var(--bs-primary);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            text-decoration: none;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
        }

        .btn-accent-custom:hover {
            background-color: #7c3aed; /* A slightly darker shade of primary */
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            color: white;
        }

        /* Corrected success badge style */
        .badge-success {
            background-color: var(--bs-success);
            color: #fff;
            font-weight: 600;
            padding: 0.35em 0.8em;
            border-radius: 9999px;
            font-size: 0.875rem;
        }
        
        /* Custom info badge for job cards with squared border */
        .badge-info-squared {
            background-color: var(--bs-info);
            color: white;
            font-weight: 600;
            padding: 0.35em 0.8em;
            border-radius: 0.25rem; /* a small radius for a "squared" look */
            font-size: 0.875rem;
            margin-right: 0.5rem;
        }

        /* Default flex layout for the clip card (PC) */
        .clips-grid {
            display: grid;
            gap: 2rem;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
        
        .clip-card {
            background-color: var(--bs-light);
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: var(--bs-shadow-sm);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: row;
            gap: 1rem;
            padding: 1rem;
        }

        .clip-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--bs-shadow-md);
        }

        .clip-card .video-wrapper {
            position: relative;
            width: 150px;
            aspect-ratio: 9/16;
            background-color: #000;
            cursor: pointer;
            border-radius: 0.5rem;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .clip-card .clip-info {
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-grow: 1;
        }

        .clip-card video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .video-wrapper.is-playing video {
            opacity: 1;
        }
        
        .clip-title {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .clip-description {
            font-size: 0.85rem;
            color: var(--bs-gray-600);
            margin-bottom: 1rem;
            white-space: normal;
            word-wrap: break-word;
        }
        
        /* --- Mobile-First Adjustments for the clips and layout --- */
        @media (max-width: 767px) {
            .live-progress-section, .process-card {
                max-width: none;
            }
            .clips-grid {
                max-width: none;
                gap: 1.5rem;
                grid-template-columns: 1fr;
            }
            .clip-card {
                flex-direction: row; /* Horizontal layout for mobile */
                gap: 0;
                padding: 0.5rem;
                align-items: center;
            }
            .clip-card .video-wrapper {
                width: 100px; /* Smaller fixed width */
                aspect-ratio: 9/16;
                border-radius: 0.5rem;
                flex-shrink: 0;
            }
            .clip-card .clip-info {
                padding: 0.5rem;
                padding-top: 0;
                flex-grow: 1;
                width: calc(100% - 110px); /* Adjust width to fit */
            }
            .clip-card .clip-info > div {
                margin-bottom: 0.5rem;
            }
            .clip-card .clip-description-container {
                margin-bottom: 0;
            }
            .clip-card .clip-description {
                display: -webkit-box;
                -webkit-line-clamp: 3; /* Limit description to 3 lines */
                -webkit-box-orient: vertical;
                overflow: hidden;
                text-overflow: ellipsis;
                font-size: 0.75rem;
            }
            .clip-card .clip-actions {
                margin-top: 0.25rem;
                justify-content: space-between;
                width: 100%;
            }
            .clip-card .clip-title {
                font-size: 0.9rem;
                margin-bottom: 0.25rem;
            }
            .clip-card .clip-actions a {
                font-size: 0.7rem;
                padding: 0.25rem 0.5rem;
            }
            .clip-card .d-flex.g-2 {
                display: flex !important;
                gap: 0.5rem;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light py-3">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
                    <img src="{{ url_for('static', filename='images/footer-logo.png') }}" alt="Velva.clip Logo" height="40">
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link text-muted" href="{{ url_for('index') }}">Create Clips</a>
                        </li>
                    </ul>
                    <div class="d-flex align-items-center">
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary rounded-pill me-2"><i class="fas fa-sign-out-alt"></i> Log Out</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="container py-4">
        <h1 class="text-center mb-1 dashboard-title-h1">Dashboard</h1>
        <div class="text-center mb-4">
            <span class="badge badge-outline-primary">Generative AI</span>
        </div>
        
        <div class="welcome-section">
            <p class="mb-0">
                Welcome back, <strong>{{ current_user.username }}</strong>!
                {% if current_user_tier == 'free' %}
                    <span class="badge badge-soft-secondary"> (Free Plan - {{ current_clip_count }}/5 clips today)</span>
                {% else %}
                    <span class="badge badge-info-custom"> ({{ current_user_tier.capitalize() }} Plan)</span>
                {% endif %}
            </p>
            <a href="{{ url_for('index') }}" class="btn-accent-custom"><i class="fas fa-plus"></i> Create New Clips</a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message alert alert-{{ 'success' if category == 'success' else 'danger' }} d-flex align-items-center" role="alert">
                        <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }} me-2"></i>
                        <div>{{ message }}</div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div id="live-progress-section" class="live-progress-section mb-5" {% if not live_process %}style="display: none;"{% endif %}>
            <div class="card live-progress-card p-4 mx-auto">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="fw-bold mb-1">Video in progress...</h5>
                        <small class="text-muted" id="processing-video-url">{{ live_process.source_url if live_process else "" }}</small>
                    </div>
                    <div>
                        <button class="btn btn-danger btn-sm" id="cancel-processing-btn">
                            <i class="fas fa-times-circle"></i> Cancel
                        </button>
                    </div>
                </div>
                <div class="live-video-preview">
                    <img id="live-video-thumbnail" src="{{ live_process_thumbnail_url or '#' }}" alt="Video Thumbnail" class="w-100 h-100 object-fit-cover">
                    <div class="live-progress-overlay">
                        <div id="live-progress-text-element" class="h5 fw-bold" style="display: none;"></div>
                        <div id="live-progress-bar-container" class="progress" style="height: 30px; width: 80%;">
                            <div id="live-progress-bar-fill" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;"></div>
                            <span id="progress-percentage-text" class="position-absolute text-white fw-bold">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <h2 class="text-center mb-4">
            <span class="badge badge-success">My Projects</span>
        </h2>

        {% if processes %}
            <div class="row g-4">
            {% for process in processes %}
                <div class="col-lg-6 mx-auto">
                    <div class="card process-card h-100 p-4" data-session-id="{{ process.session_id }}">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5 class="fw-bold mb-1">
                                    <span class="badge badge-info-squared">Project for</span>
                                    <span class="text-muted">{{ process.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                </h5>
                                <small class="text-muted" title="{{ process.source_url }}">Source: {{ process.source_url }}</small>
                            </div>
                            <div>
                                <button class="btn btn-danger btn-sm delete-project-btn" data-session-id="{{ process.session_id }}">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </div>
                        </div>

                        {% if process.clips %}
                            <div class="clips-grid mt-3">
                                {% for clip in process.clips %}
                                    <div class="clip-card card">
                                        <div class="d-flex g-2">
                                            <div class="video-wrapper">
                                                <video playsinline preload="metadata" data-duration="{{ clip.duration }}" poster="{{ url_for('serve_thumbnail', session_id=process.session_id, filename=clip.filename.replace('.mp4', '_thumb.jpg')) }}">
                                                    <source src="{{ url_for('download_clip', session_id=process.session_id, filename=clip.filename) }}" type="video/mp4">
                                                </video>
                                                <div class="video-thumbnail-overlay" style="background-image: url('{{ url_for('serve_thumbnail', session_id=process.session_id, filename=clip.filename.replace('.mp4', '_thumb.jpg')) }}');">
                                                    <i class="fas fa-play-circle play-icon"></i>
                                                </div>
                                                <div class="clip-timer-overlay">
                                                    <i class="fas fa-clock"></i> <span class="clip-duration">0:00</span>
                                                </div>
                                            </div>
                                            <div class="clip-info">
                                                <div class="mb-2">
                                                    <h6 class="clip-title">{{ clip.title }}</h6>
                                                    <div class="clip-description-container">
                                                        <p class="clip-description small text-muted">{{ clip.description }}</p>
                                                        <button class="btn btn-light btn-sm copy-btn" title="Copy description"><i class="fas fa-copy"></i></button>
                                                    </div>
                                                </div>
                                                <div class="clip-actions mt-auto d-flex flex-wrap gap-2">
                                                    <a href="{{ url_for('download_clip', session_id=process.session_id, filename=clip.filename) }}" download class="btn btn-sm btn-outline-secondary"><i class="fas fa-download"></i> Download</a>
                                                    <a href="{{ url_for('uploader_web', session_id=process.session_id) }}?video={{clip.filename}}" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="fas fa-upload"></i> Upload</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                        <div class="no-clips p-4 text-center text-muted">
                            <p>No clips were generated for this job.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
            </div>
        {% else %}
            <div class="no-jobs p-5">
                <p class="lead text-muted mb-4">You haven't processed any videos yet.</p>
                <a href="{{ url_for('index') }}" class="btn-accent-custom"><i class="fas fa-plus me-2"></i> Let's create some!</a>
            </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            function var_to_ms(cssVarName) {
                const style = getComputedStyle(document.documentElement);
                const value = style.getPropertyValue(cssVarName);
                if (value.endsWith('s')) {
                    return parseFloat(value) * 1000;
                }
                return parseFloat(value);
            }

            const videoElements = document.querySelectorAll('.clip-card video');
            videoElements.forEach(video => {
                const duration = video.dataset.duration;

                if (duration) {
                    const minutes = Math.floor(duration / 60);
                    const seconds = Math.floor(duration % 60);
                    const formattedSeconds = seconds < 10 ? '0' + seconds : seconds;
                    const formattedDuration = `${minutes}:${formattedSeconds}`;
                    
                    const timerOverlay = video.closest('.clip-card').querySelector('.clip-duration');
                    if (timerOverlay) {
                        timerOverlay.textContent = formattedDuration;
                    }
                }
            });

            const videoWrappers = document.querySelectorAll('.video-wrapper');
            videoWrappers.forEach(wrapper => {
                const video = wrapper.querySelector('video');
                const overlay = wrapper.querySelector('.video-thumbnail-overlay');
                
                video.addEventListener('loadedmetadata', () => {
                    overlay.style.backgroundImage = `url(${video.poster})`;
                    overlay.style.opacity = '1';
                });

                wrapper.addEventListener('click', () => {
                    if (video.paused) {
                        videoElements.forEach(otherVideo => {
                            if (otherVideo !== video && !otherVideo.paused) {
                                otherVideo.pause();
                                otherVideo.closest('.clip-card').classList.remove('is-playing');
                            }
                        });
                        video.play();
                        wrapper.closest('.clip-card').classList.add('is-playing');
                    } else {
                        video.pause();
                        wrapper.closest('.clip-card').classList.remove('is-playing');
                    }
                });
            });

            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const descriptionText = event.currentTarget.previousElementSibling.textContent;
                    
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(descriptionText).then(() => {
                            showCopySuccess(button);
                        }).catch(err => {
                            console.error('Failed to copy text: ', err);
                            fallbackCopyTextToClipboard(descriptionText, button);
                        });
                    } else {
                        fallbackCopyTextToClipboard(descriptionText, button);
                    }
                });
            });
            
            function showCopySuccess(button) {
                const originalIcon = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('text-success');
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                    button.classList.remove('text-success');
                }, 2000);
            }

            function fallbackCopyTextToClipboard(text, button) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.top = "0";
                textArea.style.left = "0";
                textArea.style.width = "2em";
                textArea.style.height = "2em";
                textArea.style.padding = "0";
                textArea.style.border = "none";
                textArea.style.outline = "none";
                textArea.style.boxShadow = "none";
                textArea.style.background = "transparent";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                         showCopySuccess(button);
                    } else {
                         alert('Copying text failed. Please try again manually.');
                    }
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    alert('Copying text failed. Please try again manually.');
                }
                document.body.removeChild(textArea);
            }

            document.querySelectorAll('.delete-project-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const sessionId = event.target.dataset.sessionId;
                    if (!sessionId) {
                        console.error("Session ID not found for delete button.");
                        return;
                    }

                    const confirmDeletion = confirm("Are you sure you want to delete this project and all its clips? This action cannot be undone.");
                    if (!confirmDeletion) {
                        return;
                    }

                    try {
                        const response = await fetch(`/delete_process/${sessionId}`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        const data = await response.json();

                        if (response.ok) {
                            const processCard = document.querySelector(`.process-card[data-session-id="${sessionId}"]`);
                            if (processCard) {
                                processCard.style.opacity = '0';
                                processCard.style.transform = 'translateY(20px)';
                                setTimeout(() => {
                                    processCard.remove();
                                    if (document.querySelectorAll('.process-card').length === 0) {
                                        let noJobsDiv = document.querySelector('.no-jobs');
                                        if (!noJobsDiv) {
                                            noJobsDiv = document.createElement('div');
                                            noJobsDiv.className = 'no-jobs animate-on-load';
                                            noJobsDiv.innerHTML = '<p class="lead text-muted mb-4">You haven\'t processed any videos yet.</p><a href="{{ url_for('index') }}" class="btn-accent-custom"><i class="fas fa-plus me-2"></i> Let\'s create some!</a>';
                                            document.querySelector('.container').insertAdjacentElement('beforeend', noJobsDiv);
                                        }
                                    }
                                }, 300);
                            }
                        } else {
                            alert(`Error: ${data.message || 'Could not delete project.'}`);
                        }
                    } catch (error) {
                        console.error('Fetch error:', error);
                        alert('An error occurred while trying to delete the project. Please try again.');
                    }
                });
            });
            
            const liveSessionId = "{{ live_session_id }}";
            const liveProcessStatus = "{{ live_process.status if live_process else '' }}";
            const liveProcessUrl = "{{ live_process.source_url if live_process else '' }}";

            if (liveSessionId && liveProcessStatus === 'processing' && document.getElementById('live-progress-section')) {
                const liveProgressSection = document.getElementById('live-progress-section');
                liveProgressSection.style.display = 'block';

                document.getElementById('processing-video-url').textContent = liveProcessUrl;

                const liveProgressBarFill = document.getElementById('live-progress-bar-fill');
                const progressPercentageText = document.getElementById('progress-percentage-text');

                const eventSource = new EventSource(`/logs/${liveSessionId}`);
                
                eventSource.onmessage = function(e) {
                    const message = e.data;
                    console.log("Received SSE message:", message);
                    
                    if (message.startsWith("PROGRESS:")) {
                        const progress = parseInt(message.split(':')[1]);
                        liveProgressBarFill.style.width = progress + '%';
                        progressPercentageText.textContent = `${progress}%`;
                    } else if (message.includes("PROCESSING_COMPLETE:") || message.includes("PROCESSING_ERROR:") || message.includes("STREAM_TERMINATED")) {
                        eventSource.close();
                        sessionStorage.removeItem('live_session_id');
                        setTimeout(() => window.location.href = "{{ url_for('dashboard') }}", 1000);
                    } else {
                        console.log(message);
                    }
                };

                eventSource.onerror = function(e) {
                    console.error("EventSource failed:", e);
                    eventSource.close();
                    sessionStorage.removeItem('live_session_id');
                    setTimeout(() => window.location.href = "{{ url_for('dashboard') }}", 1000);
                };

                document.getElementById('cancel-processing-btn').addEventListener('click', async () => {
                    const confirmCancel = confirm("Are you sure you want to cancel this process?");
                    if (confirmCancel) {
                         try {
                            const response = await fetch(`/delete_process/${liveSessionId}`, {
                                method: 'DELETE',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            if (response.ok) {
                                alert("Process cancelled successfully.");
                                sessionStorage.removeItem('live_session_id');
                                window.location.reload();
                            } else {
                                alert("Failed to cancel process.");
                            }
                        } catch (error) {
                            console.error("Cancel error:", error);
                            alert("An error occurred while trying to cancel the process.");
                        }
                    }
                });
            } else {
                 document.getElementById('live-progress-section').style.display = 'none';
            }
        });
    </script>
</body>
</html>